//gcc -rdynamic -o dlopentest dlopentest.c -ldl
// ./dlopentest
#include <stdio.h>
#include <stdlib.h>
#include <dlfcn.h>
#include "data.h"

int
main (int argc, char **argv)
{
  void *handle;
  data_export *data_from_lib;

  data_export *(*init_data) (void);

  char *error;

  handle = dlopen ("/home/gmunasin/dlopen/libdata.so", RTLD_LAZY);
  if (!handle)
    {
      fprintf (stderr, "%s\n", dlerror ());
      exit (EXIT_FAILURE);
    }

  dlerror ();			/* Clear any existing error */

  init_data = dlsym (handle, "init_data");

  if ((error = dlerror ()) != NULL)
    {
      fprintf (stderr, "%s\n", error);
      exit (EXIT_FAILURE);
    }

  data_from_lib = (*init_data) ();
  data_from_lib->say_hello ();
  data_from_lib->say_hi ();
  printf ("Adding from libdata.so : %d\n", data_from_lib->add_number (1, 2));

  dlclose (handle);
  exit (EXIT_SUCCESS);
}
